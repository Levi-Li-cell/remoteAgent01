<template>
  <view class="notification-settings-page">
    <!-- å¯¼èˆªæ  -->
    <view class="navbar">
      <view class="nav-left" @click="goBack">
        <text class="nav-icon">â†</text>
      </view>
      <view class="nav-title">é€šçŸ¥è®¾ç½®</view>
      <view class="nav-right"></view>
    </view>

    <!-- è®¾ç½®å†…å®¹ -->
    <view class="settings-content">
      <!-- é€šçŸ¥æ¸ é“è®¾ç½® -->
      <view class="settings-section">
        <view class="section-title">é€šçŸ¥æ¸ é“</view>
        <view class="section-desc">é€‰æ‹©æ‚¨å¸Œæœ›æ¥æ”¶é€šçŸ¥çš„æ–¹å¼</view>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-icon">ğŸ“±</text>
            <view class="setting-details">
              <text class="setting-name">ç«™å†…æ¶ˆæ¯</text>
              <text class="setting-desc">åœ¨åº”ç”¨å†…æ¥æ”¶é€šçŸ¥æ¶ˆæ¯</text>
            </view>
          </view>
          <switch 
            :checked="settings.in_app" 
            @change="updateSetting('in_app', $event.detail.value)"
            color="#007aff"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-icon">ğŸ“§</text>
            <view class="setting-details">
              <text class="setting-name">é‚®ä»¶é€šçŸ¥</text>
              <text class="setting-desc">é€šè¿‡é‚®ä»¶æ¥æ”¶é‡è¦é€šçŸ¥</text>
            </view>
          </view>
          <switch 
            :checked="settings.email" 
            @change="updateSetting('email', $event.detail.value)"
            color="#007aff"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-icon">ğŸ’¬</text>
            <view class="setting-details">
              <text class="setting-name">çŸ­ä¿¡é€šçŸ¥</text>
              <text class="setting-desc">é€šè¿‡çŸ­ä¿¡æ¥æ”¶é‡è¦é€šçŸ¥</text>
            </view>
          </view>
          <switch 
            :checked="settings.sms" 
            @change="updateSetting('sms', $event.detail.value)"
            color="#007aff"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-icon">ğŸ””</text>
            <view class="setting-details">
              <text class="setting-name">æ¨é€é€šçŸ¥</text>
              <text class="setting-desc">é€šè¿‡ç³»ç»Ÿæ¨é€æ¥æ”¶é€šçŸ¥</text>
            </view>
          </view>
          <switch 
            :checked="settings.push" 
            @change="updateSetting('push', $event.detail.value)"
            color="#007aff"
          />
        </view>
      </view>

      <!-- é€šçŸ¥ç±»å‹è®¾ç½® -->
      <view class="settings-section">
        <view class="section-title">é€šçŸ¥ç±»å‹</view>
        <view class="section-desc">é€‰æ‹©æ‚¨å¸Œæœ›æ¥æ”¶çš„é€šçŸ¥ç±»å‹</view>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-icon">ğŸ“¦</text>
            <view class="setting-details">
              <text class="setting-name">è®¢å•é€šçŸ¥</text>
              <text class="setting-desc">è®¢å•çŠ¶æ€å˜æ›´ã€å‘è´§ã€ç­¾æ”¶ç­‰</text>
            </view>
          </view>
          <switch 
            :checked="settings.order_notifications" 
            @change="updateSetting('order_notifications', $event.detail.value)"
            color="#007aff"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-icon">ğŸ’³</text>
            <view class="setting-details">
              <text class="setting-name">æ”¯ä»˜é€šçŸ¥</text>
              <text class="setting-desc">æ”¯ä»˜æˆåŠŸã€å¤±è´¥ã€é€€æ¬¾ç­‰</text>
            </view>
          </view>
          <switch 
            :checked="settings.payment_notifications" 
            @change="updateSetting('payment_notifications', $event.detail.value)"
            color="#007aff"
          />
        </view>

        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-icon">ğŸ‰</text>
            <view class="setting-details">
              <text class="setting-name">ä¿ƒé”€é€šçŸ¥</text>
              <text class="setting-desc">ä¼˜æƒ æ´»åŠ¨ã€æ–°å“ä¸Šæ¶ç­‰</text>
            </view>
          </view>
          <switch 
            :checked="settings.promotion_notifications" 
            @change="updateSetting('promotion_notifications', $event.detail.value)"
            color="#007aff"
          />
        </view>
      </view>

      <!-- å…æ‰“æ‰°æ—¶é—´è®¾ç½® -->
      <view class="settings-section">
        <view class="section-title">å…æ‰“æ‰°æ—¶é—´</view>
        <view class="section-desc">è®¾ç½®ä¸æ¥æ”¶é€šçŸ¥çš„æ—¶é—´æ®µ</view>
        
        <view class="setting-item">
          <view class="setting-info">
            <text class="setting-icon">ğŸŒ™</text>
            <view class="setting-details">
              <text class="setting-name">å¤œé—´å…æ‰“æ‰°</text>
              <text class="setting-desc">22:00 - 08:00 ä¸æ¥æ”¶é€šçŸ¥</text>
            </view>
          </view>
          <switch 
            :checked="settings.night_mode" 
            @change="updateSetting('night_mode', $event.detail.value)"
            color="#007aff"
          />
        </view>

        <view v-if="settings.night_mode" class="time-range-setting">
          <view class="time-item">
            <text class="time-label">å¼€å§‹æ—¶é—´</text>
            <picker mode="time" :value="settings.night_start" @change="updateSetting('night_start', $event.detail.value)">
              <view class="time-value">{{ settings.night_start }}</view>
            </picker>
          </view>
          
          <view class="time-item">
            <text class="time-label">ç»“æŸæ—¶é—´</text>
            <picker mode="time" :value="settings.night_end" @change="updateSetting('night_end', $event.detail.value)">
              <view class="time-value">{{ settings.night_end }}</view>
            </picker>
          </view>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <button class="save-btn" @click="saveSettings" :disabled="saving">
          {{ saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜è®¾ç½®' }}
        </button>
        
        <button class="reset-btn" @click="resetSettings">
          æ¢å¤é»˜è®¤è®¾ç½®
        </button>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      settings: {
        // é€šçŸ¥æ¸ é“
        in_app: true,
        email: true,
        sms: false,
        push: true,
        
        // é€šçŸ¥ç±»å‹
        order_notifications: true,
        payment_notifications: true,
        promotion_notifications: false,
        
        // å…æ‰“æ‰°è®¾ç½®
        night_mode: false,
        night_start: '22:00',
        night_end: '08:00'
      },
      originalSettings: {},
      saving: false
    }
  },

  onLoad() {
    this.loadSettings()
  },

  methods: {
    async loadSettings() {
      try {
        const res = await this.$request({
          url: '/api/notifications/settings',
          method: 'GET'
        })

        if (res.data) {
          this.settings = { ...this.settings, ...res.data }
          this.originalSettings = { ...this.settings }
        }
      } catch (error) {
        console.error('åŠ è½½é€šçŸ¥è®¾ç½®å¤±è´¥:', error)
        uni.showToast({
          title: 'åŠ è½½è®¾ç½®å¤±è´¥',
          icon: 'none'
        })
      }
    },

    updateSetting(key, value) {
      this.settings[key] = value
    },

    async saveSettings() {
      if (this.saving) return

      this.saving = true

      try {
        await this.$request({
          url: '/api/notifications/settings',
          method: 'PUT',
          data: this.settings
        })

        this.originalSettings = { ...this.settings }

        uni.showToast({
          title: 'è®¾ç½®ä¿å­˜æˆåŠŸ',
          icon: 'success'
        })

      } catch (error) {
        console.error('ä¿å­˜é€šçŸ¥è®¾ç½®å¤±è´¥:', error)
        uni.showToast({
          title: 'ä¿å­˜å¤±è´¥',
          icon: 'none'
        })
      } finally {
        this.saving = false
      }
    },

    resetSettings() {
      uni.showModal({
        title: 'æ¢å¤é»˜è®¤è®¾ç½®',
        content: 'ç¡®å®šè¦æ¢å¤é»˜è®¤çš„é€šçŸ¥è®¾ç½®å—ï¼Ÿ',
        success: (res) => {
          if (res.confirm) {
            this.settings = {
              in_app: true,
              email: true,
              sms: false,
              push: true,
              order_notifications: true,
              payment_notifications: true,
              promotion_notifications: false,
              night_mode: false,
              night_start: '22:00',
              night_end: '08:00'
            }

            uni.showToast({
              title: 'å·²æ¢å¤é»˜è®¤è®¾ç½®',
              icon: 'success'
            })
          }
        }
      })
    },

    goBack() {
      // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
      const hasChanges = JSON.stringify(this.settings) !== JSON.stringify(this.originalSettings)
      
      if (hasChanges) {
        uni.showModal({
          title: 'æç¤º',
          content: 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ',
          success: (res) => {
            if (res.confirm) {
              uni.navigateBack()
            }
          }
        })
      } else {
        uni.navigateBack()
      }
    }
  }
}
</script>

<style lang="scss" scoped>
.notification-settings-page {
  min-height: 100vh;
  background-color: #f5f5f5;
}

.navbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 88rpx;
  padding: 0 30rpx;
  background-color: white;
  border-bottom: 1rpx solid #eee;

  .nav-left, .nav-right {
    width: 60rpx;
  }

  .nav-icon {
    font-size: 36rpx;
    color: #333;
  }

  .nav-title {
    font-size: 32rpx;
    font-weight: 500;
    color: #333;
  }
}

.settings-content {
  padding: 20rpx;
}

.settings-section {
  background-color: white;
  border-radius: 16rpx;
  margin-bottom: 30rpx;
  overflow: hidden;

  .section-title {
    padding: 30rpx 30rpx 10rpx;
    font-size: 32rpx;
    font-weight: 500;
    color: #333;
  }

  .section-desc {
    padding: 0 30rpx 20rpx;
    font-size: 26rpx;
    color: #999;
    line-height: 1.4;
  }
}

.setting-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 30rpx;
  border-bottom: 1rpx solid #f0f0f0;

  &:last-child {
    border-bottom: none;
  }

  .setting-info {
    display: flex;
    align-items: center;
    flex: 1;

    .setting-icon {
      font-size: 32rpx;
      margin-right: 20rpx;
    }

    .setting-details {
      flex: 1;

      .setting-name {
        font-size: 30rpx;
        color: #333;
        margin-bottom: 8rpx;
        display: block;
      }

      .setting-desc {
        font-size: 24rpx;
        color: #999;
        line-height: 1.3;
      }
    }
  }
}

.time-range-setting {
  padding: 0 30rpx 30rpx;
  border-top: 1rpx solid #f0f0f0;

  .time-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20rpx 0;

    .time-label {
      font-size: 28rpx;
      color: #333;
    }

    .time-value {
      padding: 12rpx 20rpx;
      background-color: #f8f8f8;
      border-radius: 8rpx;
      font-size: 28rpx;
      color: #007aff;
    }
  }
}

.action-buttons {
  padding: 40rpx 0;

  .save-btn, .reset-btn {
    width: 100%;
    height: 80rpx;
    border-radius: 16rpx;
    font-size: 30rpx;
    font-weight: 500;
    margin-bottom: 20rpx;
    border: none;

    &:last-child {
      margin-bottom: 0;
    }
  }

  .save-btn {
    background-color: #007aff;
    color: white;

    &:disabled {
      background-color: #ccc;
    }
  }

  .reset-btn {
    background-color: white;
    color: #666;
    border: 1rpx solid #ddd;
  }
}
</style>
